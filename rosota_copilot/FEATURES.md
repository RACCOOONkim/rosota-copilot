# 기능 명세서

## 📋 구현 완료된 기능

### 1. 자동 연결 감지 ✅

#### 기능 설명
USB 포트를 자동으로 스캔하여 SO Arm 100/101 로봇을 감지하고 연결합니다.

#### 구현 세부사항
- **파일**: `rosota_copilot/robot/usb_scanner.py`
- **방법**: PID 기반 자동 감지 (CH340 칩셋 PID 21971, 29987)
- **폴백**: 포트 이름 기반 감지 (`/dev/ttyUSB*`, `/dev/ttyACM*`)
- **자동 스캔**: 서버 시작 시 및 5초마다 자동 스캔
- **연결 상태 표시**: 상단 상태바에 실시간 연결 정보 표시

#### API
- `GET /api/ports`: 사용 가능한 시리얼 포트 목록
- `POST /api/connect`: 로봇 연결 (포트 자동 감지 지원)

#### Socket.IO 이벤트
- `robot:auto_connected`: 자동 연결 성공 시 알림

---

### 2. 전압 자동 감지 및 설정 ✅

#### 기능 설명
로봇의 전압(6V 또는 12V)을 자동으로 감지하고, 전압에 맞는 기본 설정을 자동으로 로드합니다.

#### 구현 세부사항
- **파일**: `rosota_copilot/robot/so_arm.py`
- **전압 감지**: `detect_voltage()`, `read_motor_voltage()` 메서드
- **설정 파일**:
  - `resources/configs/so-100-6V.json` (6V용)
  - `resources/configs/so-100-12V.json` (12V용)
- **자동 로드**: 연결 시 전압 감지 후 자동으로 설정 파일 로드
- **PID 게인 적용**: 전압별 최적 PID 게인 자동 적용

#### API
- `GET /api/voltage`: 로봇 전압 정보 조회

---

### 3. 단계별 캘리브레이션 마법사 ✅

#### 기능 설명
3단계로 구성된 캘리브레이션 마법사를 통해 로봇을 쉽게 캘리브레이션할 수 있습니다.

#### 구현 세부사항
- **파일**: `rosota_copilot/robot/calibration.py`
- **단계**:
  1. **Position 1**: 모든 조인트를 0도 위치로 이동
  2. **Position 2**: CALIBRATION_POSITION으로 이동
  3. **Position 3**: 최종 검증
- **자동 토크 제어**: 각 단계에서 토크 자동 활성화/비활성화
- **진행 상태 표시**: 진행률 바 및 단계별 안내 메시지
- **상세 로그**: 각 단계별 상세 로그 출력

#### API
- `POST /api/calibration/wizard/step`: 다음 단계 실행
- `GET /api/calibration/wizard/status`: 현재 상태 조회
- `POST /api/calibration/wizard/reset`: 마법사 리셋
- `POST /api/calibration/home`: 홈 포지션으로 이동
- `POST /api/calibration/zero`: 조인트 제로 설정
- `POST /api/calibration/run`: 전체 캘리브레이션 실행

#### Socket.IO 이벤트
- `calibration:log`: 캘리브레이션 로그 실시간 전송

---

### 4. 키보드 텔레오퍼레이션 ✅

#### 기능 설명
키보드를 사용하여 로봇을 실시간으로 제어할 수 있습니다.

#### 구현 세부사항
- **파일**: `rosota_copilot/robot/keyboard_control.py`
- **제어 주기**: 50ms 간격 (20Hz)
- **3가지 모드**:
  - **Joint 모드**: 각 관절 개별 제어 (6 DOF)
  - **Cartesian 모드**: 엔드 이펙터 위치/자세 제어
  - **Gripper 모드**: 그리퍼 제어
- **한글 입력 모드 지원**: `e.code`를 사용한 물리적 키 감지
- **안전 기능**:
  - E-Stop (Space 키)
  - 속도 조절 (+/- 키)
  - 조인트 제한 확인

#### 키 매핑
- **Joint 모드**: I/K, J/L, U/O, 7/9, 8/0, Y/H
- **Cartesian 모드**: W/S, A/D, Q/E, R/F, T/G, Z/X
- **Gripper 모드**: C (토글)
- **공통**: M (모드 전환), +/- (속도), Space (E-Stop)

#### API
- `POST /api/control/start`: 키보드 제어 시작
- `POST /api/control/stop`: 키보드 제어 중지
- `GET /api/control/status`: 키보드 제어 상태 조회

#### Socket.IO 이벤트
- `control:key`: 키보드 입력 전송 (클라이언트 → 서버)
- `control:response`: 제어 명령 응답 (서버 → 클라이언트)

---

### 5. 온보딩 튜토리얼 ✅

#### 기능 설명
사용자가 처음 사용할 때 튜토리얼을 통해 시스템 사용법을 배울 수 있습니다.

#### 구현 세부사항
- **형태**: 페이지 형태 (모달 아님)
- **위치**: 사이드바 메뉴 최상단
- **3단계 가이드**:
  1. 로봇 연결
  2. 캘리브레이션
  3. 키보드 제어
- **페이지 네비게이션**:
  - 이전/다음 버튼
  - 페이지 인디케이터 (점)
  - 인디케이터 클릭으로 페이지 이동
- **첫 실행 감지**: localStorage를 사용하여 첫 방문 감지
- **자동 표시**: 첫 방문 시 1초 후 튜토리얼 섹션으로 자동 이동

---

### 6. 다국어 지원 ✅

#### 기능 설명
한국어와 영어를 지원하며, 실시간으로 언어를 전환할 수 있습니다.

#### 구현 세부사항
- **지원 언어**: 한국어 (ko), 영어 (en)
- **번역 시스템**: `data-i18n` 속성 기반 동적 번역
- **번역 데이터**: `translations` 객체에 모든 번역 저장
- **자동 감지**: 브라우저 언어 자동 감지
- **설정 저장**: localStorage에 언어 설정 저장
- **실시간 전환**: 언어 변경 시 즉시 UI 업데이트

#### 번역 범위
- 메뉴 항목
- 섹션 제목 및 설명
- 버튼 텍스트
- 상태 메시지
- 키보드 힌트
- 로그 메시지

---

### 7. 테마 지원 ✅

#### 기능 설명
Light, Dark, System 테마를 지원하며, 사용자 선호도에 맞게 테마를 선택할 수 있습니다.

#### 구현 세부사항
- **테마 옵션**: Light, Dark, System
- **시스템 테마 감지**: OS 설정에 따라 자동 전환
- **CSS 변수**: `data-theme` 속성 기반 테마 적용
- **설정 저장**: localStorage에 테마 설정 저장
- **실시간 전환**: 테마 변경 시 즉시 적용

#### 테마 변수
- `--bg-primary`: 기본 배경색
- `--bg-secondary`: 보조 배경색
- `--bg-card`: 카드 배경색
- `--text-primary`: 기본 텍스트 색상
- `--text-secondary`: 보조 텍스트 색상
- `--accent`: 강조 색상
- `--border`: 테두리 색상
- `--shadow`: 그림자 색상

---

### 8. 실시간 모니터링 ✅

#### 기능 설명
로봇의 상태를 실시간으로 모니터링하고 표시합니다.

#### 구현 세부사항
- **업데이트 주기**: 20Hz (50ms 간격)
- **상태 정보**:
  - 연결 상태
  - 조인트 위치 (6개)
  - TCP 포즈 (직교좌표)
  - 그리퍼 상태
  - 제어 모드
  - 속도 배율
- **상태 표시**: 상단 상태바 및 상태 섹션에 표시

#### API
- `GET /api/state`: 현재 로봇 상태 조회

#### Socket.IO 이벤트
- `state:update`: 로봇 상태 업데이트 (20Hz)

---

### 9. 실시간 로그 시스템 ✅

#### 기능 설명
시스템의 모든 로그를 실시간으로 표시합니다.

#### 구현 세부사항
- **로그 패널**: 오른쪽 고정 패널
- **로그 레벨**: INFO, SUCCESS, WARNING, ERROR
- **색상 구분**: 레벨별 색상 구분
- **자동 스크롤**: 새 로그 자동 스크롤 옵션
- **로그 지우기**: Clear 버튼으로 로그 지우기
- **실시간 전송**: Socket.IO를 통한 실시간 로그 전송

#### 로그 소스
- 캘리브레이션 로그
- 제어 동작 로그
- 연결 상태 로그
- 에러 로그

---

## 🔧 기술적 구현 세부사항

### 하드웨어 인터페이스
- **FeetechMotorsBus**: phosphobot의 모터 제어 라이브러리 사용
- **시리얼 통신**: pyserial을 사용한 USB 통신
- **Baudrate**: 1,000,000 (1Mbps)
- **Resolution**: 4096 (12-bit)

### 소프트웨어 아키텍처
- **백엔드**: FastAPI + Socket.IO (ASGI)
- **프론트엔드**: 순수 HTML/CSS/JavaScript
- **비동기 처리**: `run_in_executor`로 블로킹 방지
- **상태 관리**: 전역 인스턴스 및 app.state 사용

### 보안 및 안전
- **조인트 제한 확인**: 이동 전 제한 범위 확인
- **E-Stop 기능**: 긴급 정지 기능
- **에러 처리**: 상세한 에러 메시지 및 트레이스백
- **연결 상태 확인**: 제어 전 연결 상태 확인

---

## 📊 구현 진행률

| 기능 | 진행률 | 상태 |
|------|--------|------|
| 자동 연결 감지 | 100% | ✅ 완료 |
| 전압 감지 및 설정 | 100% | ✅ 완료 |
| 캘리브레이션 마법사 | 100% | ✅ 완료 |
| 키보드 텔레오퍼레이션 | 100% | ✅ 완료 |
| 온보딩 튜토리얼 | 100% | ✅ 완료 |
| 다국어 지원 | 100% | ✅ 완료 |
| 테마 지원 | 100% | ✅ 완료 |
| 실시간 모니터링 | 100% | ✅ 완료 |
| 실시간 로그 시스템 | 100% | ✅ 완료 |

**전체 진행률: 100%** ✅

---

## 🎯 향후 개선 사항

### 1. 시각적 가이드
- 캘리브레이션 단계별 로봇 위치 이미지/애니메이션
- 3D 로봇 모델 시각화

### 2. 고급 기능
- 조인트 제한 범위 수동 조정
- PID 게인 수동 조정 UI
- 다중 캘리브레이션 프로필 지원

### 3. 사용자 경험
- 키보드 단축키 커스터마이징
- 제어 속도 프로필 저장
- 작업 히스토리 기록

